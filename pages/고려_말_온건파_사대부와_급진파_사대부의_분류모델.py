# -*- coding: utf-8 -*-
"""ê³ ë ¤ ë§ ì˜¨ê±´íŒŒ ì‚¬ëŒ€ë¶€ì™€ ê¸‰ì§„íŒŒ ì‚¬ëŒ€ë¶€ì˜ ë¶„ë¥˜ëª¨ë¸.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1IrN7kK4MMENusyJk-ASgnHO5qNfPr4Pj
"""

pip install google-generativeai requests beautifulsoup4

import os
import requests
from bs4 import BeautifulSoup
import google.generativeai as genai
import streamlit as st  # ì´ ì¤„ì´ ì—†ìœ¼ë©´ ë§¨ ìœ„ì— ì¶”ê°€í•´ì£¼ì„¸ìš”!

# ì´ì œ ì‹¤ì œ í‚¤ ëŒ€ì‹  'ë¹„ë°€ ê¸ˆê³ 'ë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤
GOOGLE_API_KEY = st.secrets["GEMINI_API_KEY"]
genai.configure(api_key=GOOGLE_API_KEY)

model = genai.GenerativeModel('gemini-2.5-flash')

class HistoryClassifier:
    def __init__(self):
        self.base_url = "https://db.history.go.kr/integrated/search/searchResult.do"
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        }

    def scrape_history_db(self, name):
        """
        í•œêµ­ì‚¬ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¸ë¬¼ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰í•˜ì—¬ ê´€ë ¨ í…ìŠ¤íŠ¸ ì¡°ê°(Snippet)ì„ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
        """
        print(f"ğŸŒ '{name}'ì— ëŒ€í•œ ì •ë³´ë¥¼ í•œêµ­ì‚¬ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìˆ˜ì§‘ ì¤‘...")

        params = {
            'keyword': name,
            'wc': 'on'  # ì „ì²´ ê²€ìƒ‰
        }

        try:
            response = requests.get(self.base_url, params=params, headers=self.headers, timeout=10)
            response.raise_for_status() # 404 ë“± ì—ëŸ¬ ì²´í¬

            soup = BeautifulSoup(response.text, 'html.parser')

            # ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (ì‚¬ì´íŠ¸ êµ¬ì¡°ì— ë”°ë¼ í´ë˜ìŠ¤ëª…ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ, ì¼ë°˜ì ì¸ êµ¬ì¡° íƒ€ê²ŸíŒ…)
            results = soup.select('.ul_list li .cont')

            scraped_texts = []
            if not results:
                # ê²°ê³¼ê°€ ì—†ì„ ê²½ìš° ë‹¤ë¥¸ ì„ íƒì ì‹œë„
                results = soup.select('.search_result li')

            for item in results[:5]: # ìƒìœ„ 5ê°œ ê²°ê³¼ë§Œ ì°¸ì¡° (í† í° ì ˆì•½ ë° ì†ë„)
                text = item.get_text(strip=True)
                scraped_texts.append(text)

            if not scraped_texts:
                print("âš ï¸ ê²€ìƒ‰ ê²°ê³¼ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. AIì˜ ë°°ê²½ì§€ì‹ì„ í™œìš©í•©ë‹ˆë‹¤.")
                return None

            return "\n".join(scraped_texts)

        except Exception as e:
            print(f"âŒ ìŠ¤í¬ë˜í•‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return None

    def analyze_character(self, name):
        """
        ìˆ˜ì§‘ëœ ì •ë³´ì™€ AIì˜ ì§€ì‹ì„ ê²°í•©í•˜ì—¬ ì¸ë¬¼ì„ ë¶„ë¥˜í•©ë‹ˆë‹¤.
        """
        # 1. ì •ë³´ ìˆ˜ì§‘
        db_context = self.scrape_history_db(name)

        # 2. í”„ë¡¬í”„íŠ¸ êµ¬ì„± (RAG ë°©ì‹)
        prompt = f"""
        ë‹¹ì‹ ì€ ê³ ë ¤ ë§ê³¼ ì¡°ì„  ì´ˆê¸°ì˜ ì—­ì‚¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
        ì•„ë˜ ì œê³µëœ 'í•œêµ­ì‚¬ë°ì´í„°ë² ì´ìŠ¤ ê²€ìƒ‰ ê²°ê³¼'ì™€ ë‹¹ì‹ ì˜ 'ë°°ê²½ì§€ì‹'ì„ ì¢…í•©í•˜ì—¬ ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰í•˜ì„¸ìš”.

        ë¶„ì„ ëŒ€ìƒ ì¸ë¬¼: {name}

        [í•œêµ­ì‚¬ë°ì´í„°ë² ì´ìŠ¤ ê²€ìƒ‰ ê²°ê³¼]
        {db_context if db_context else "ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ (ë°°ê²½ì§€ì‹ ìœ„ì£¼ë¡œ íŒë‹¨í•˜ì„¸ìš”)"}

        [ì§€ì‹œì‚¬í•­]
        1. ì´ ì¸ë¬¼ì´ ê³ ë ¤ ë§ 'ì˜¨ê±´íŒŒ ì‚¬ëŒ€ë¶€(ìœ ì§€íŒŒ)'ì¸ì§€ 'ê¸‰ì§„íŒŒ ì‚¬ëŒ€ë¶€(ì—­ì„±í˜ëª…íŒŒ)'ì¸ì§€ ëª…í™•íˆ ë¶„ë¥˜í•˜ì„¸ìš”.
        2. ë§Œì•½ ì‚¬ëŒ€ë¶€ê°€ ì•„ë‹ˆê±°ë‚˜(ë¬´ì‹  ë“±), ë¶„ë¥˜ê°€ ëª¨í˜¸í•˜ë‹¤ë©´ ê·¸ ì‚¬ì‹¤ì„ ëª…ì‹œí•˜ì„¸ìš”.
        3. ë¶„ë¥˜ì˜ í•µì‹¬ ê·¼ê±°ë¥¼ 3ê°€ì§€ ì´ë‚´ë¡œ ìš”ì•½í•´ì„œ ì„¤ëª…í•˜ì„¸ìš”.

        [ì¶œë ¥ í˜•ì‹]
        - ì´ë¦„: {name}
        - ë¶„ë¥˜: [ì˜¨ê±´íŒŒ ì‚¬ëŒ€ë¶€ / ê¸‰ì§„íŒŒ ì‚¬ëŒ€ë¶€ / ê¸°íƒ€]
        - í•µì‹¬ ê·¼ê±°:
          1. ...
          2. ...
        - í•œì¤„ ìš”ì•½: ...
        """

        # 3. AI ë¶„ì„ ì‹¤í–‰
        print("ğŸ¤– AIê°€ ì—­ì‚¬ì  ì‚¬ë£Œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...")
        try:
            response = model.generate_content(prompt)
            return response.text
        except Exception as e:
            return f"âŒ AI ë¶„ì„ ì‹¤íŒ¨: {e}"

# ==========================================
# ë©”ì¸ ì‹¤í–‰ë¶€
# ==========================================
def main():
    classifier = HistoryClassifier()

    print("=== ê³ ë ¤ ë§ ì¸ë¬¼ ì„±í–¥ ë¶„ë¥˜ê¸° (By Gemini & í•œêµ­ì‚¬DB) ===")
    print("ì¢…ë£Œí•˜ë ¤ë©´ 'q'ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n")

    while True:
        user_input = input("ì¸ë¬¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì •ëª½ì£¼, ì •ë„ì „): ").strip()

        if user_input.lower() == 'q':
            print("í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            break

        if not user_input:
            continue

        result = classifier.analyze_character(user_input)

        print("\n" + "="*40)
        print(result)
        print("="*40 + "\n")

if __name__ == "__main__":
    main()
